#!/usr/bin/env bash
source /dev/stdin < <(cli shim)
. $(dirname ${BASH_SOURCE})/cli.sh

help() {
util::unindent << EOF
    Command
        cli self-test

    Summary
        Run a self test for every command. 
        
    Description
        Commands are found via recursive search starting at '--dir'.
        Those commands are then invoked with the flag '--self-test'.
        If all test succeed, the exit code is 0, otherwise 1.

    Arguments
        --dir           : The directory to start searching for commands.

    Global Arguments
        --help -h       : Show this message and exit.
        --self-test     : Runs a self test.
EOF
}

EXIT_CODE=0

report_test_results() { 
    if read result; then
        EXIT_CODE=1

        echo
        echo $1
        echo "${result}"
    fi

    while read result; do
        echo "${result}"
    done
}

run_test() {
    while read command; do 
        "${command}" --self-test | report_test_results "${command}"
    done
}

main() {
    cli find commands --dir "${arg_dir}" --recursive | run_test
    exit "${EXIT_CODE}"
}

test() (
    return
)

shim "$@"